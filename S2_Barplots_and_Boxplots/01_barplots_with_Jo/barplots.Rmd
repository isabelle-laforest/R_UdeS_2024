---
title: "barplots_ggplot"
date: "2024-01-06"
Author: Jonathan Rondeau-Leclaire
---

```{r, include=FALSE}
library(tidyverse)
```

## Data preparation

The data : Microbial Order abundance by sample.

We have 131 samples taken on four different plant hosts (mosses) on either the brown or green compartment of the plant. For each microbial Phylum identified, the count represents the absolute number of sequences in a sample that were attributed to that Phylum. We want to compare these numbers across compartments and hosts.

First, let's have a look at the data: 

```{r}
# Import the data file
seq_count <- read.delim("sequence_counts.tsv") # by default, read.delim assumes the file has a header, and that it is separated by tabulations ("\t")
head(seq_count)
# How many samples do we have by group and compartment ?
seq_count %>% 
  select(Sample, Host, Compartment) %>% # ignore the seq_count and Phylum columns
  unique %>% # Keep one line per unique combinations of these variables
  dplyr::summarise(n_samples = n(), # count the number of samples for each
                   .by = c('Host', 'Compartment'))
```
The columns whose values are not numbers are considered "character" columns. You can see this by looking at the structure of your object, where "chr" means character and "int" means integer.

```{r}
str(seq_count)
```
To work well with ggplot, we need them to be factors. You can see factors as a set of categories that represents each unique value in a variable. For example, we have two Compartment factors (Brown or Green). Here's a quick way to convert all character columns to factors, using a little trick from the very useful 'dplyr' package.

```{r}
seq_count <- seq_count %>% 
  # the mutate() function modifies the values of a variable
  mutate(across(where(is.character), as.factor))

# Make sure the factors are as expected
str(seq_count)
```

There, you can see that our four variables are now factors and you can validate the number of levels for each. 

## Barplot : Phylum 

We want to look at how microbial Orders are distributed across our samples using their sequence counts. We'll start very simple, by using the sum of all samples for each Phylum.

```{r}
ggplot(seq_count, aes(x = Seq_count, y = Phylum)) + 
  geom_col()
```

That's nice, but now we'd like to see if these counts differ much across compartments, i.e. the green vs. the brown part of the plants. 

```{r}
ggplot(seq_count, aes(x = Seq_count, y = Phylum)) + 
  geom_col(aes(fill = Compartment)) 
```

That's not bad, but we might want to have each column side-by-side insteade of stacked on top of each other. The "position" argument is going to help us here. While we're at it, let's use some proper colours:

```{r}
ggplot(seq_count, aes(x = Seq_count, y = Phylum)) + 
  geom_col(aes(fill = Compartment), 
           position = "dodge") # Dodge the columns, so we can read the counts
```

Since plots are meant to be pretty, let's do a couple more things: 
1. Use some coherent colours (green and brown!)
2. Remove the gray background (personal preference) by imposing a minimal theme
3. Rename the x axis and add a plot title

```{r}
comp_colours <- c("lightsalmon4", "springgreen4")

ggplot(seq_count, aes(x = Seq_count, y = Phylum)) + 
  geom_col(aes(fill = Compartment), position = "dodge") + 
  scale_fill_manual(values = comp_colours) + # follows factor levels
  labs(title = "Total Phylum sequence counts by compartment.",
       x = "Sum of sequence counts") +
  theme_minimal()
```

## Barplots with facets

A different way of looking at the data could be to compare Host and Compartment at the same time. To visualize the Orders across these two sample data, we can use faceting.

In this case, we'll start by plotting the counts for each host

```{r}
ggplot(seq_count, aes(y = Host, x = Seq_count)) + 
  geom_bar(aes(fill = Phylum),
           stat = 'identity') # Notice:we don't use the "dodge" option, so the counts stack.
```

How can we look at each compartment separately? Faceting will help us !
```{r}
ggplot(seq_count, aes(y = Host, x = Seq_count)) + 
  geom_bar(aes(fill = Phylum), stat = 'identity') +
    # This is where the magic happens:
  facet_grid(cols = vars(Compartment), # Adds facets
             scales="free") # allows different x-axis scales for each facet
```

That's fine, but it reveals a weakness in the way we are presenting data. Indeed, the number of sequences is usually much smaller in the green compartment. One way to solve this is to normalize to 1, which is equivalent to showing the relative counts instead of the absolute counts. We can easily achieve this without modifying our original data :

```{r}
ggplot(seq_count, aes(y = Host, x = Seq_count)) + 
  geom_bar(aes(fill = Phylum), stat = 'identity', 
           position = 'fill') + # normalises total values to 1
  facet_grid(cols = vars(Compartment)) +
  xlab("Proportion of sequence counts") # not absolute values
```

Notice, the counts were normalized to 1.